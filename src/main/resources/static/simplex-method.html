<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .constraintDiv { 
            display: flex;
            flex-direction: row;
        }
        .variablesDiv {
            display: flex;
            flex-direction: row;
        }
    </style>
</head>
<body>
    <label for="constraintCount">Количество ограничений: </label>
    <input type="number" class="numTextBox" min="2" max="10" value="3" id="constraintCount">

    <label for="variableCount">Количество переменных: </label>
    <input type="number" class="numTextBox" min="2" max="10" value="3" id="variableCount">

    <div id="constraintsContainer">
    </div>

    <div id="objectiveFunc">
        <span>F = </span>
        <input type="text" id="obj0">
        <span> + </span>
        <input type="text" id="obj1">
        <span>→</span>
        <select id="directionSelect" class="direction-select">
            <option value="MIN">min</option>
            <option value="MAX">max</option>
        </select>
    </div>

    <button onclick="sendData()">Решить задачу</button>
    <input type="file" id="fileInput" />
</body>

<script>
    let constraintCountTextbox = document.getElementById("constraintCount");
    constraintCountTextbox.addEventListener('change', handleConstraintChange);
    window.addEventListener('load', () => handleConstraintChange({target: constraintCountTextbox}));

    function handleConstraintChange(e) {
        let constraintsContainer = document.getElementById('constraintsContainer');
        let constraints = constraintsContainer.querySelectorAll(".constraintDiv");

        // Проверка ввода количества ограничений
        let targetConstraintCount = parseInt(e.target.value) || 2;
        targetConstraintCount = Math.max(2, Math.min(10, targetConstraintCount));
        constraintCountTextbox.value = targetConstraintCount;

        let currentCount = constraints.length;
    
        if (currentCount > targetConstraintCount) {
            removeConstraint(constraints, targetConstraintCount);
        } 
        else if (currentCount < targetConstraintCount) {
            addConstraint(constraintsContainer, currentCount, targetConstraintCount);
        }
    }

    function removeConstraint(constraints, targetConstraintCount) {
        console.log(constraints);
        for (let i = constraints.length; i > targetConstraintCount; i--) {
            constraints[i - 1].remove();
        }
    }

    function addConstraint(constraintsContainer, currentLength, targetConstraintCount) {
        for (let i = currentLength; i < targetConstraintCount; i++) {
            let constraintDiv = document.createElement('div');
            constraintDiv.className = 'constraintDiv';
            constraintDiv.id = `c${i}`;
            let variablesDiv = document.createElement('div');
            variablesDiv.className = 'variablesDiv';
            for (let j = 0; j < 2; j++) {
                let variableTextbox = document.createElement('input');
                variableTextbox.setAttribute('type', 'text');
                variableTextbox.setAttribute('id', `v${i}${j}`);

                let xLabel = document.createElement('span');
                xLabel.innerHTML = `x<sub>${j + 1}</sub>`;

                let variableDiv = document.createElement('div');
                variableDiv.className = 'varDiv';

                if (j != 0) {
                    let spanPlus = document.createElement('span');
                    spanPlus.innerHTML = '<span>+</span>';
                    variableDiv.appendChild(spanPlus);
                }

                variableDiv.appendChild(variableTextbox);
                variableDiv.appendChild(xLabel);

                variablesDiv.append(variableDiv);
            }

            constraintDiv.appendChild(variablesDiv);
            let select = document.createElement('select');
            select.className = 'operator-select';
            select.id = `operatorSelect${i}`;

            const options = [
                { value: 'LEQ', symbol: '≤' },
                { value: 'GEQ', symbol: '≥' }
            ];

            options.forEach(opt => {
                let option = document.createElement('option');
                option.value = opt.value;
                option.textContent = opt.symbol;
                select.appendChild(option);
            });


            let rhsTextbox = document.createElement('input');
            rhsTextbox.setAttribute('type', 'text');
            rhsTextbox.setAttribute('id', `rhs${i}`);

            constraintDiv.appendChild(select);
            constraintDiv.appendChild(rhsTextbox);            
            constraintsContainer.appendChild(constraintDiv);
        }
    }

    let variableCountTextbox = document.getElementById("variableCount");
    variableCountTextbox.addEventListener('change', handleVariableChange);
    window.addEventListener('load', () => handleVariableChange({target: variableCountTextbox}));
    constraintCountTextbox.addEventListener('change', handleVariableChange);

    function handleVariableChange() {
        // Проверка ввода количества ограничений
        let targetCount = parseInt(variableCountTextbox.value) || 2;
        targetCount = Math.max(2, Math.min(10, targetCount));
        variableCountTextbox.value = targetCount;

        let currentCount = document.querySelectorAll('#constraintsContainer>#c0>.variablesDiv>div').length;
        if (currentCount > targetCount) {
            removeVariable(targetCount);
        } else {
            addVariable(targetCount);
        }
    }

    function removeVariable(targetCount) {
        let constraintsLength = document.querySelectorAll('#constraintsContainer>div').length;
        for (let i = 0; i < constraintsLength; i++) {
            let variables = document.querySelectorAll(`#c${i} .variablesDiv div`);
            console.log(variables);
            for (let j = variables.length; j > targetCount; j--) {
                variables[j - 1].remove();
            }
        }
    }

    function addVariable(targetCount) {
        let constraintsLength = document.querySelectorAll('#constraintsContainer>div').length;
        for (let i = 0; i < constraintsLength; i++) {
            let variablesDiv = document.querySelector(`#c${i}>.variablesDiv`);
            let variablesLength = document.querySelectorAll(`#c${i}>.variablesDiv>.varDiv`).length;

            for (let j = variablesLength; j < targetCount; j++) {
                let variableDiv = document.createElement('div');
                variableDiv.className = 'varDiv';
                
                let spanPlus = document.createElement('span');
                spanPlus.innerHTML = '<span>+</span>';

                let input = document.createElement('input');
                input.id = `v${i}${j}`;

                let spanX = document.createElement('span');
                spanX.innerHTML = `x<sub>${j+1}</sub>`;

                variableDiv.appendChild(spanPlus);
                variableDiv.appendChild(input);
                variableDiv.appendChild(spanX);
                variablesDiv.appendChild(variableDiv);
            }
        }

    }


    function sendData() {
        const data = getData();
        console.log(data);

        fetch('http://localhost:8080/solve/simplex', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            console.log('Результат:', data);
        })
        .catch(error => {
            console.error('Ошибка:', error);
        });
    }

    function getData() {
        const objective = {
            coefficients: [
                parseFraction(document.getElementById('obj0').value),
                parseFraction(document.getElementById('obj1').value)
            ],
            direction: document.getElementById('directionSelect').value
        };

        const constraints = [];
        const constraintDivs = document.querySelectorAll('#constraintsContainer > div');
        let variablesCount = document.getElementById("variableCount").value;

        constraintDivs.forEach((div, index) => {
            const coeffs = [];
            
            for(let i = 0; i < variablesCount; i++) {
                const input = document.getElementById(`v${index}${i}`);
                console.log("input: " + input.value);
                coeffs.push(parseFraction(input.value));
            }

            const constraint = {
                coefficients: coeffs,
                operator: document.querySelector(`#c${index} select`).value,
                rhs: parseFraction(document.getElementById(`rhs${index}`).value)
            };
            
            constraints.push(constraint);
        });

        const data = {
            objective,
            constraints
        };
        console.log(data);

        return data;
    }
</script>
<script>
    // При выборе файла читаем его с помощью FileReader
    document.getElementById("fileInput").addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (event) {
        const content = event.target.result;
        // Выводим содержимое в консоль (можно убрать)
        console.log("Содержимое файла:\n" + content);
        // Парсим содержимое файла
        const lpProblem = parseLPFile(content);
        console.log(lpProblem);

        document.getElementById("constraintCount").value = lpProblem.numConstraints;
        const changeEvent = new Event("change", {
            bubbles: false,    // событие всплывающее, если это необходимо
            cancelable: false // событие нельзя отменить
        });   
        document.getElementById("constraintCount").dispatchEvent(changeEvent);

        document.getElementById("variableCount").value = lpProblem.numVars;
        document.getElementById("variableCount").dispatchEvent(changeEvent);

        for (let i = 0; i < lpProblem.numConstraints; i++) {
            for (let j = 0; j < lpProblem.numVars; j++) {
                document.getElementById(`v${i}${j}`).value = lpProblem.constraints[i].coefficients[j];
            }

            if (lpProblem.constraints[i].comparator == ">=") {
                    document.querySelector(`#c${i} select`).value = 'GEQ';
                } else {
                    document.querySelector(`#c${i} select`).value = 'LEQ';
                }

            document.getElementById(`rhs${i}`).value = lpProblem.constraints[i].rhs;
        }

        document.getElementById('obj0').value = lpProblem.objective.coefficients[0];
        document.getElementById('obj1').value = lpProblem.objective.coefficients[1];
        document.getElementById('directionSelect').value = lpProblem.objective.type;
      };
      reader.readAsText(file);
    });

    /**
     * Функция для парсинга текста файла в объект с ограничениями и целевой функцией.
     * @param {string} content - содержимое файла
     * @return {Object} объект с полями:
     *         numConstraints - количество ограничений,
     *         constraints - массив ограничений { coefficients, comparator, rhs },
     *         objective - целевая функция { type, coefficients }
     */
     function parseLPFile(content) {
        // Разбиваем содержимое на строки, удаляя пустые строки
        const lines = content.split(/\r?\n/).filter((line) => line.trim() !== "");
        let index = 0;

        // Первая строка содержит число ограничений и количество переменных
        const [numConstraints, numVars] = lines[index].trim().split(/\s+/).map(Number);
        index++;

        const constraints = [];

        // Читаем ограничения
        for (let i = 0; i < numConstraints; i++, index++) {
            // Например строка "1 1 <= 7"
            // Разбиваем строку на токены по пробелам
            const tokens = lines[index].trim().split(/\s+/);
            
            // Берем только первые numVars токенов как коэффициенты
            const coefficients = tokens.slice(0, numVars).map(Number);
            
            // Знак неравенства - это токен после коэффициентов
            const comparator = tokens[numVars];
            
            // Правая часть - это последний токен
            const rhs = Number(tokens[numVars + 1]);

            constraints.push({
                coefficients,
                comparator,
                rhs,
            });
        }

        // Следующая строка – тип целевой функции ("MAX" или "MIN")
        const objectiveType = lines[index].trim().toUpperCase();
        index++;

        // Следующая строка – коэффициенты целевой функции
        const objectiveCoefficients = lines[index].trim().split(/\s+/).map(Number);
        index++;

        return {
            numConstraints,
            numVars,
            constraints,
            objective: {
            type: objectiveType,
            coefficients: objectiveCoefficients,
            },
        };
    }
  </script>
  <script>
    function parseFraction(input) {
        console.log("here1");
        console.log(input);
        if (!input || input.trim() === '') {
            return { numerator: 0, denominator: 1 };
        }
        
        // Проверяем, содержит ли строка символ "/"
        if (input.includes('/')) {
            console.log('here3');
            const parts = input.split('/');
            console.log(parts);
            if (parts.length === 2) {
                const numerator = parseInt(parts[0].trim());
                const denominatorStr = parts[1].trim();
                
                if (denominatorStr === '0') {
                    alert('Знаменатель не может быть равен нулю!');
                    return { numerator: 0, denominator: 1 };
                }
                
                const denominator = parseInt(denominatorStr) || 1;
                return { numerator, denominator };
            }
        }
        
        // Если это десятичное число
        if (!isNaN(parseFloat(input))) {
            // Преобразуем десятичное число в дробь
            const decimal = parseFloat(input);
            // Десятичное число как "5" просто станет дробью 5/1
            if (Number.isInteger(decimal)) {
                return { numerator: decimal, denominator: 1 };
            } 
            // Для чисел вроде 0.5 превращаем их в дробь 1/2
            else {
                // Находим количество десятичных знаков
                const strNum = decimal.toString();
                const decimalPart = strNum.includes('.') ? strNum.split('.')[1] : '';
                const multiplier = Math.pow(10, decimalPart.length);
                
                // Умножаем на 10^n, чтобы получить целое число
                const numerator = Math.round(decimal * multiplier);
                const denominator = multiplier;
                
                return { 
                    numerator: numerator, 
                    denominator: denominator 
                };
            }
        }
        
        // Если не удалось распарсить, возвращаем ноль
        return { numerator: 0, denominator: 1 };
    }
  </script>
</html>